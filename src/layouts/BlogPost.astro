---
import { Image } from "astro:assets";
import type { CollectionEntry } from "astro:content";
import BaseLayout from "./BaseLayout.astro";
import Footer from "../components/Footer.astro";
import FormattedDate from "../components/FormattedDate.astro";
import Header from "../components/Header.astro";
import Icon from "../components/Icon.astro";

type Props = CollectionEntry<"blog">["data"];

const {
	title,
	titleEn,
	description,
	pubDate,
	updatedDate,
	heroImage,
	category,
	moral,
	readingTime,
	genre,
} = Astro.props;

import { SITE_AUTHOR, SITE_URL } from "../consts";
import ReadingControls from "../components/ReadingControls.astro";

// Get the current page URL for sharing
const currentUrl = Astro.url.href;
const encodedUrl = encodeURIComponent(currentUrl);
const encodedTitle = encodeURIComponent(title);

const articleSchema = JSON.stringify({
	"@context": "https://schema.org",
	"@type": "ShortStory",
	headline: `${titleEn ? titleEn + " - " : ""}${title}`,
	name: title,
	description: description,
	image: heroImage ? new URL(heroImage.src, Astro.url).toString() : undefined,
	author: {
		"@type": "Person",
		name: SITE_AUTHOR,
	},
	publisher: {
		"@type": "Organization",
		name: "StoriesPDF",
		logo: {
			"@type": "ImageObject",
			url: `${SITE_URL}/logo.svg`,
		},
	},
	genre: genre || "Moral Story",
	inLanguage: "en",
	datePublished: pubDate.toISOString(),
	dateModified: (updatedDate || pubDate).toISOString(),
});

const breadcrumbSchema = JSON.stringify({
	"@context": "https://schema.org",
	"@type": "BreadcrumbList",
	itemListElement: [
		{
			"@type": "ListItem",
			position: 1,
			name: "Home",
			item: SITE_URL,
		},
		{
			"@type": "ListItem",
			position: 2,
			name: "Stories",
			item: `${SITE_URL}/blog`,
		},
		...(category
			? [
					{
						"@type": "ListItem",
						position: 3,
						name: category,
						item: `${SITE_URL}/${category}-stories`,
					},
				]
			: []),
		{
			"@type": "ListItem",
			position: category ? 4 : 3,
			name: titleEn || title,
			item: currentUrl,
		},
	],
});
---

<BaseLayout
	title={`${titleEn ? titleEn + " - " : ""}${title}`}
	description={description}
	image={heroImage}
>
	<Fragment slot="head">
		<script type="application/ld+json" set:html={articleSchema} />
		<script type="application/ld+json" set:html={breadcrumbSchema} />
	</Fragment>
	<Header />

	<!-- Reading Progress Bar -->
	<div
		id="reading-progress"
		class="fixed top-16 left-0 w-0 h-1 bg-gradient-to-r from-[var(--color-accent)] to-[var(--color-secondary)] z-40 transition-all duration-150"
	>
	</div>

	<main
		class="pt-24 pb-16 px-4 sm:px-6 lg:px-8 max-w-7xl mx-auto overflow-x-hidden"
	>
		<!-- Breadcrumb -->
		<div class="max-w-3xl mx-auto mb-6">
			<nav
				class="flex items-center gap-2 text-sm text-[var(--color-text-muted)]"
			>
				<a
					href="/"
					class="hover:text-[var(--color-accent)] transition-colors"
					>Home</a
				>
				<Icon name="chevron-right" size={14} />
				<a
					href="/blog"
					class="hover:text-[var(--color-accent)] transition-colors"
					>Stories</a
				>
				<Icon name="chevron-right" size={14} />
				<span
					class="text-[var(--color-text-main)] font-medium truncate max-w-[200px]"
					>{title}</span
				>
			</nav>
		</div>

		<article>
			<!-- Hero Section -->
			<header class="max-w-3xl mx-auto mb-8">
				<!-- Category Badge -->
				<div
					class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-[var(--color-secondary)]/30 text-[var(--color-text-main)] text-xs font-medium border border-[var(--color-secondary)] mb-4"
				>
					<span class="w-2 h-2 rounded-full bg-[var(--color-accent)]"
					></span>
					Children's Story
				</div>

				<!-- Title -->
				<h1
					class="text-3xl sm:text-4xl lg:text-5xl font-semibold text-[var(--color-text-main)] tracking-tight leading-tight mb-4"
				>
					{title}
				</h1>
				{
					titleEn && (
						<h2 class="text-xl md:text-2xl text-[var(--color-text-muted)] font-medium mb-6 mt-0 border-none !pb-0">
							{titleEn}
						</h2>
					)
				}

				<!-- Description -->
				<p
					class="text-lg sm:text-xl text-[var(--color-text-muted)] leading-relaxed mb-6"
				>
					{description}
				</p>

				<!-- Meta Row -->
				<div
					class="flex flex-wrap items-center gap-4 text-sm text-[var(--color-text-muted)]"
				>
					<span class="inline-flex items-center gap-2">
						<Icon name="clock" size={16} />
						<span id="reading-time">3 minutes</span>
					</span>
				</div>
			</header>

			<!-- Hero Image -->
			{
				heroImage && (
					<div class="max-w-3xl mx-auto mb-10 rounded-2xl overflow-hidden shadow-xl border border-[var(--color-border)] group relative">
						<div class="absolute inset-0 bg-gradient-to-t from-[var(--color-primary)]/20 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300" />
						<Image
							width={1200}
							height={600}
							src={heroImage}
							alt={title}
							class="w-full h-auto object-cover"
							loading="eager"
							decoding="sync"
							fetchpriority="high"
							format="avif"
						/>
					</div>
				)
			}

			<div class="max-w-3xl mx-auto">
				<ReadingControls readingTime={readingTime} />
			</div>

			<!-- Content Container -->
			<div class="max-w-3xl mx-auto">
				<div
					class="prose prose-lg prose-slate dark:prose-invert max-w-none leading-relaxed"
				>
					<slot />
					{/* Moral of the Story Section */}
					{
						moral && (
							<div class="moral-section mt-12 bg-[var(--color-accent)]/5 border-l-4 border-[var(--color-accent)] p-6 rounded-r-xl">
								<h3 class="text-xl font-bold text-[var(--color-text-main)] mb-2 flex items-center gap-2">
									<Icon
										name="lightbulb"
										size={24}
										class="text-[var(--color-accent)]"
									/>
									Moral of the Story
								</h3>
								<p class="text-lg text-[var(--color-text-muted)] italic font-medium leading-relaxed">
									{moral}
								</p>
							</div>
						)
					}
				</div>
			</div>

			<!-- Share Section -->
			<div
				class="max-w-3xl mx-auto mt-12 pt-8 border-t border-[var(--color-border)]"
			>
				<h4
					class="font-semibold text-[var(--color-text-main)] mb-4 text-center"
				>
					Share This Story
				</h4>
				<div class="flex justify-center gap-3">
					<a
						href={`https://wa.me/?text=${encodedTitle}%20${encodedUrl}`}
						target="_blank"
						rel="noopener noreferrer"
						class="w-11 h-11 rounded-full bg-[#25D366] text-white flex items-center justify-center hover:scale-105 transition-transform border border-[#25D366]/20"
						title="Share on WhatsApp"
					>
						<Icon name="message-circle" size={22} />
					</a>
					<a
						href={`https://twitter.com/intent/tweet?text=${encodedTitle}&url=${encodedUrl}`}
						target="_blank"
						rel="noopener noreferrer"
						class="w-11 h-11 rounded-full bg-[#1DA1F2] text-white flex items-center justify-center hover:scale-105 transition-transform border border-[#1DA1F2]/20"
						title="Share on Twitter"
					>
						<Icon name="twitter" size={22} />
					</a>
					<a
						href={`https://www.facebook.com/sharer/sharer.php?u=${encodedUrl}`}
						target="_blank"
						rel="noopener noreferrer"
						class="w-11 h-11 rounded-full bg-[#1877F2] text-white flex items-center justify-center hover:scale-105 transition-transform border border-[#1877F2]/20"
						title="Share on Facebook"
					>
						<Icon name="facebook" size={22} />
					</a>
					<button
						id="copy-link-mobile"
						class="w-11 h-11 rounded-full bg-[var(--color-text-main)] text-[var(--color-bg)] flex items-center justify-center hover:bg-[var(--color-accent)] hover:scale-105 transition-all border border-[var(--color-border)]"
						title="Copy Link"
					>
						<Icon name="link" size={22} />
					</button>
				</div>
			</div>

			<!-- Navigation -->
			<div
				class="max-w-3xl mx-auto mt-8 flex flex-col sm:flex-row gap-4 justify-between"
			>
				<a
					href="/blog"
					class="inline-flex items-center justify-center gap-2 px-6 py-3 bg-[var(--color-bg)] border border-[var(--color-border)] text-[var(--color-text-main)] rounded-xl font-medium text-sm hover:bg-[var(--color-accent)] hover:text-white transition-all duration-300"
				>
					<Icon name="arrow-left" size={16} />
					All Stories
				</a>
				<button
					id="scroll-to-top"
					class="inline-flex items-center justify-center gap-2 px-6 py-3 bg-[var(--color-accent)] text-white rounded-xl font-medium text-sm hover:bg-[var(--color-text-main)] transition-all duration-300 border border-[var(--color-accent)]/20"
				>
					<Icon name="arrow-up" size={16} />
					Back to Top
				</button>
			</div>
		</article>
	</main>
</BaseLayout>

<Footer />

<style is:global>
	/* ===== Enhanced Prose Styling for Optimal Readability ===== */

	.prose {
		--tw-prose-body: var(--color-text-muted);
		--tw-prose-headings: var(--color-text-main);
		--tw-prose-lead: var(--color-text-muted);
		--tw-prose-links: var(--color-accent);
		--tw-prose-bold: var(--color-text-main);
		--tw-prose-counters: var(--color-accent);
		--tw-prose-bullets: var(--color-accent);
		--tw-prose-hr: var(--color-border);
		--tw-prose-quotes: var(--color-text-main);
		--tw-prose-quote-borders: var(--color-accent);
		--tw-prose-captions: var(--color-text-muted);
		--tw-prose-code: var(--color-text-main);
		--tw-prose-pre-code: var(--color-text-main);
		--tw-prose-pre-bg: var(--color-bg);
		--tw-prose-th-borders: var(--color-border);
		--tw-prose-td-borders: var(--color-border);

		/* Optimized typography for reading */
		font-family: var(--font-reading);
		font-size: 1.2rem;
		line-height: 1.75;
		text-align: justify;
		hyphens: auto;
		-webkit-hyphens: auto;
		word-spacing: 0.05em;
		letter-spacing: 0.01em;
	}

	/* Paragraph spacing for clear visual separation */
	.prose p {
		margin-bottom: 1.5em;
	}

	/* Headings - keep sans-serif for contrast */
	.prose h1,
	.prose h2,
	.prose h3 {
		font-family: "Inter", sans-serif;
		font-weight: 700;
		margin-top: 2em;
		margin-bottom: 0.75em;
		line-height: 1.3;
		text-align: left;
	}

	.prose h2 {
		border-bottom: 3px solid var(--color-secondary);
		padding-bottom: 0.5em;
		display: inline-block;
	}

	/* Link styling */
	.prose a {
		text-decoration: none;
		border-bottom: 2px solid var(--color-accent);
		transition: all 0.2s;
	}
	.prose a:hover {
		background-color: var(--color-accent);
		color: white;
	}

	/* Blockquotes - enhanced readability */
	.prose blockquote {
		background: var(--color-bg);
		border-left-color: var(--color-accent);
		border-left-width: 4px;
		font-style: italic;
		border-radius: 0 1rem 1rem 0;
		padding: 1em 1.5em;
	}

	/* Image captions - refined styling */
	.prose figcaption,
	.prose img + em {
		font-size: 0.9em;
		color: var(--color-text-muted);
		text-align: center;
		display: block;
		margin-top: 0.5em;
	}

	/* Drop Cap - refined for elegance */
	.prose > p:first-of-type::first-letter {
		float: left;
		font-size: 2.75em;
		line-height: 0.85;
		margin-right: 0.4rem;
		margin-top: 0.1em;
		font-weight: 700;
		font-family: "Inter", sans-serif;
		color: var(--color-accent);
	}
</style>

<script>
	// Reading progress bar
	const progressBar = document.getElementById("reading-progress");

	function updateProgress() {
		const scrollTop = window.scrollY;
		const docHeight =
			document.documentElement.scrollHeight - window.innerHeight;
		const progress = (scrollTop / docHeight) * 100;
		if (progressBar) {
			progressBar.style.width = `${Math.min(progress, 100)}%`;
		}
	}

	window.addEventListener("scroll", updateProgress);
	updateProgress();

	// Scroll to top
	const scrollTopBtn = document.getElementById("scroll-to-top");
	scrollTopBtn?.addEventListener("click", () => {
		window.scrollTo({ top: 0, behavior: "smooth" });
	});

	// Copy link functionality
	const copyBtns = [document.getElementById("copy-link-mobile")];

	copyBtns.forEach((btn) => {
		btn?.addEventListener("click", async () => {
			try {
				await navigator.clipboard.writeText(window.location.href);
				// Show feedback - change icon temporarily
				const originalHTML = btn.innerHTML;
				btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6 9 17l-5-5"/></svg>`;
				setTimeout(() => {
					btn.innerHTML = originalHTML;
				}, 2000);
			} catch (err) {
				console.error("Failed to copy:", err);
			}
		});
	});

	// Calculate reading time
	const content = document.querySelector(".prose");
	if (content) {
		const text = content.textContent || "";
		const words = text.trim().split(/\s+/).length;
		const readingTime = Math.ceil(words / 150); // Tamil reading speed ~150 wpm
		const timeText = `${readingTime} minutes`;

		const timeElements = [document.getElementById("reading-time")];

		timeElements.forEach((el) => {
			if (el) el.textContent = timeText;
		});
	}
</script>
