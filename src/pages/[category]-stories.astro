---
import BaseLayout from "../layouts/BaseLayout.astro";
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";
import { SITE_TITLE, SITE_DESCRIPTION } from "../consts";
import { getCollection } from "astro:content";
import FormattedDate from "../components/FormattedDate.astro";
import { Image } from "astro:assets";

export async function getStaticPaths() {
    const categories = [
        // Children's categories
        {
            slug: "children-bedtime",
            title: "Bedtime Stories",
            audience: "children",
            icon: "moon",
            color: "purple",
        },
        {
            slug: "children-adventure",
            title: "Kids Adventures",
            audience: "children",
            icon: "compass",
            color: "green",
        },
        {
            slug: "children-moral",
            title: "Moral Tales",
            audience: "children",
            icon: "heart",
            color: "pink",
        },
        {
            slug: "children-fairy",
            title: "Fairy Tales",
            audience: "children",
            icon: "sparkles",
            color: "yellow",
        },
        // General audience categories
        {
            slug: "general-inspirational",
            title: "Inspirational",
            audience: "general",
            icon: "sun",
            color: "orange",
        },
        {
            slug: "general-humor",
            title: "Humor & Comedy",
            audience: "general",
            icon: "smile",
            color: "teal",
        },
        {
            slug: "general-folklore",
            title: "Folklore & Culture",
            audience: "general",
            icon: "globe",
            color: "indigo",
        },
        // Adult categories
        {
            slug: "adult-drama",
            title: "Drama",
            audience: "adult",
            icon: "theater",
            color: "red",
        },
        {
            slug: "adult-thriller",
            title: "Thriller & Mystery",
            audience: "adult",
            icon: "search",
            color: "slate",
        },
        {
            slug: "adult-romance",
            title: "Romance",
            audience: "adult",
            icon: "heart",
            color: "rose",
        },
    ];

    return categories.map(({ slug, title, audience, icon, color }) => ({
        params: { category: slug },
        props: { categoryName: title, audience, icon, color },
    }));
}

const { category } = Astro.params;
const { categoryName, audience, icon, color } = Astro.props;

const posts = (await getCollection("blog"))
    .filter((post) => post.data.category === category)
    .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

const audienceLabels = {
    children: "For Kids",
    general: "All Ages",
    adult: "For Adults",
};

const title = `${categoryName} Stories | ${SITE_TITLE}`;
const description = `Read the best ${categoryName} stories. Perfect ${audienceLabels[audience as keyof typeof audienceLabels]} reading collection.`;

const collectionSchema = JSON.stringify({
    "@context": "https://schema.org",
    "@type": "CollectionPage",
    name: title,
    description: description,
    url: Astro.url.href,
    mainEntity: {
        "@type": "ItemList",
        itemListElement: posts.map((post, index) => ({
            "@type": "ListItem",
            position: index + 1,
            url: `${Astro.site}blog/${post.data.slug || post.id}/`,
            name: post.data.title,
        })),
    },
});
---

<BaseLayout title={title} description={description}>
    <Fragment slot="head">
        <script type="application/ld+json" set:html={collectionSchema} />
    </Fragment>
    <Header />
    <main class="w-full max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pt-24 pb-16">
        <div class="mb-12 text-center">
            <h1 class="text-3xl md:text-5xl font-bold text-[#11224E] mb-4">
                {categoryName}
            </h1>

            <div class="h-1 w-24 bg-[#F87B1B] mx-auto mt-6 rounded-full"></div>
        </div>

        {
            posts.length > 0 ? (
                <section class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                    {posts.map((post, index) => (
                        <a
                            href={`/blog/${post.data.slug || post.id}/`}
                            class="group"
                        >
                            <article class="bg-white rounded-2xl overflow-hidden shadow-sm hover:shadow-xl transition-all duration-300 border border-[#11224E]/5 h-full flex flex-col">
                                <div class="relative overflow-hidden aspect-[16/10]">
                                    {post.data.heroImage ? (
                                        <Image
                                            width={720}
                                            height={360}
                                            src={post.data.heroImage}
                                            alt={post.data.title}
                                            class="object-cover w-full h-full group-hover:scale-105 transition-transform duration-500"
                                            loading={
                                                index < 6 ? "eager" : "lazy"
                                            }
                                            decoding={
                                                index < 6 ? "sync" : "async"
                                            }
                                            fetchpriority={
                                                index < 3 ? "high" : "low"
                                            }
                                            format="avif"
                                        />
                                    ) : (
                                        <div class="w-full h-full bg-[#11224E]/5 flex items-center justify-center text-[#11224E]/20">
                                            <span
                                                class="iconify"
                                                data-icon="lucide:image"
                                                data-width="48"
                                                data-height="48"
                                            />
                                        </div>
                                    )}
                                    {post.data.category && (
                                        <div class="absolute top-4 right-4 bg-white/90 backdrop-blur-sm px-3 py-1 rounded-full text-xs font-semibold text-[#11224E] shadow-sm">
                                            {post.data.titleEn || "Story"}
                                        </div>
                                    )}
                                </div>
                                <div class="p-6 flex-1 flex flex-col">
                                    <h2 class="text-xl font-bold text-[#11224E] mb-3 group-hover:text-[#F87B1B] transition-colors line-clamp-2">
                                        {post.data.title}
                                    </h2>
                                    <p class="text-[#11224E]/60 text-sm mb-4 line-clamp-3 flex-1">
                                        {post.data.description}
                                    </p>
                                    <div class="flex items-center justify-between text-xs text-[#11224E]/40 mt-auto pt-4 border-t border-[#11224E]/5">
                                        <FormattedDate
                                            date={post.data.pubDate}
                                        />
                                        <span class="flex items-center gap-1">
                                            Read Story
                                            <span
                                                class="iconify"
                                                data-icon="lucide:arrow-right"
                                                data-width="12"
                                                data-height="12"
                                            />
                                        </span>
                                    </div>
                                </div>
                            </article>
                        </a>
                    ))}
                </section>
            ) : (
                <div class="text-center py-20 bg-white rounded-3xl border border-[#11224E]/5">
                    <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-[#11224E]/5 mb-6">
                        <span
                            class="iconify text-[#11224E]/40"
                            data-icon="lucide:book-open"
                            data-width="32"
                            data-height="32"
                        />
                    </div>
                    <h3 class="text-xl font-medium text-[#11224E] mb-2">
                        No stories found
                    </h3>
                    <p class="text-[#11224E]/60">
                        Check back later for new stories in this category.
                    </p>
                </div>
            )
        }
    </main>
    <Footer />
</BaseLayout>
